# 故障排查指南

## 文件丢失问题排查

如果重新部署后文件丢失，请按照以下步骤排查：

### 1. 运行诊断脚本

在Railway控制台或本地运行诊断脚本：

```bash
npm run diagnose
```

诊断脚本会检查：
- 数据库连接状态
- 数据库表和数据记录
- 文件存储目录状态
- 环境变量配置

### 2. 检查Railway配置

#### 检查PostgreSQL数据库服务

1. 在Railway项目页面，找到PostgreSQL服务
2. 确认服务状态为"Online"
3. 检查`DATABASE_URL`环境变量是否正确注入到Web服务中
4. **重要**：确认是否创建了新的PostgreSQL服务实例（这会导致连接到新数据库）

#### 检查Volume配置

1. 在Railway Web服务页面，点击"Settings"
2. 滚动到"Volumes"部分
3. 确认是否有Volume挂载：
   - **Mount Path**: `/data/uploads`
   - **Name**: `uploads`（可选）
4. 如果没有Volume，按照以下步骤添加：
   - 点击"+ New Volume"
   - Mount Path: `/data/uploads`
   - 点击"Add"保存

### 3. 检查部署日志

在Railway Web服务页面：

1. 点击"Deployments"标签
2. 查看最新的部署日志
3. 查找以下关键信息：
   - `[Database] 连接信息` - 确认数据库连接
   - `✓ 上传目录已准备` - 确认文件目录创建
   - `✓ Volume挂载检查` - 确认Volume正确挂载
   - `⚠️  检测到数据库中已有 X 条记录` - 确认数据保护机制工作
   - 任何错误信息

### 4. 常见问题和解决方案

#### 问题1：数据库连接到了新实例

**症状**：数据库中有表结构，但没有数据

**原因**：Railway可能创建了新的PostgreSQL服务实例

**解决方案**：
1. 检查Railway中是否有多个PostgreSQL服务
2. 确认Web服务连接的`DATABASE_URL`指向正确的数据库
3. 如果有备份，恢复数据库

#### 问题2：Volume未正确挂载

**症状**：数据库中有文件记录，但文件无法访问（404错误）

**原因**：Volume未配置或挂载路径不正确

**解决方案**：
1. 检查Volume配置（见步骤2）
2. 确认挂载路径为`/data/uploads`
3. 检查部署日志中的Volume挂载检查信息

#### 问题3：环境变量配置错误

**症状**：文件路径不正确或数据库连接失败

**原因**：环境变量未正确设置

**解决方案**：
1. 检查以下环境变量：
   - `DATABASE_URL` - 应该自动从PostgreSQL服务注入
   - `NODE_ENV` - 应该设置为`production`
   - `UPLOADS_PATH` - 可选，如果设置会覆盖默认路径
2. 确认环境变量在Web服务中正确设置

### 5. 数据恢复

如果数据丢失，可能的恢复方法：

1. **数据库备份**：
   - 检查Railway是否自动备份了PostgreSQL数据库
   - 如果有备份，可以从备份恢复

2. **Volume文件**：
   - 如果Volume中还有文件，但数据库记录丢失
   - 可以尝试重新扫描Volume中的文件并重建数据库记录

3. **从本地备份恢复**：
   - 如果有本地数据库备份，可以导入到Railway数据库

### 6. 预防措施

为避免未来数据丢失：

1. **定期备份数据库**：
   - 使用Railway的自动备份功能
   - 或手动导出数据库

2. **确认Volume配置**：
   - 在每次部署前确认Volume配置正确

3. **监控部署日志**：
   - 部署后检查日志，确认没有错误
   - 确认数据保护机制正常工作

4. **测试部署**：
   - 在测试环境先测试部署流程
   - 确认数据不会丢失

## 诊断脚本输出说明

运行`npm run diagnose`后，会输出以下信息：

- **数据库连接**：确认连接到正确的数据库
- **表状态**：确认表存在且有数据
- **文件记录**：确认数据库中有文件记录
- **文件存储**：确认Volume正确挂载且有文件
- **环境变量**：确认关键环境变量正确设置

根据诊断结果，可以快速定位问题所在。

