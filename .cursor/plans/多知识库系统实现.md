# 多知识库系统实现计划

## 目标
支持多个知识库，每个知识库拥有独立的步骤和关卡结构，用户可以在不同知识库间切换，文档按知识库分类管理。

## 架构设计

### 数据模型
```
knowledge_bases (知识库表)
├── id: TEXT PRIMARY KEY
├── name: TEXT (知识库名称)
├── description: TEXT (描述)
├── icon: TEXT (图标标识)
├── color: TEXT (主题颜色)
├── is_default: INTEGER (是否默认，0/1)
├── created_at: INTEGER
└── updated_at: INTEGER

modules (模块表，重命名并扩展)
├── id: TEXT PRIMARY KEY
├── knowledge_base_id: TEXT (外键 -> knowledge_bases.id)
├── step_number: INTEGER
├── step_name: TEXT
├── checkpoint_number: INTEGER
├── checkpoint_name: TEXT
├── description: TEXT
├── order_index: INTEGER
└── created_at: INTEGER

source_items (文档表，扩展)
├── ... (现有字段)
└── knowledge_base_id: TEXT (外键 -> knowledge_bases.id)
```

## 实现步骤

### 阶段1：数据库结构调整

#### 1.1 创建知识库表
**文件**: `backend/scripts/add-knowledge-bases.js`

- 创建 `knowledge_bases` 表
- 插入默认知识库（"创业流程"），将现有"6步18关"数据迁移到该知识库
- 设置 `is_default = 1` 标记默认知识库

#### 1.2 扩展模块表
**文件**: `backend/scripts/migrate-modules-to-knowledge-bases.js`

- 将 `entrepreneurship_modules` 重命名为 `modules`
- 添加 `knowledge_base_id` 字段
- 为现有所有模块设置默认知识库ID
- 添加外键约束（可选，SQLite支持有限）

#### 1.3 扩展文档表
**文件**: `backend/scripts/add-knowledge-base-to-documents.js`

- 为 `source_items` 表添加 `knowledge_base_id` 字段
- 为现有所有文档设置默认知识库ID（基于 `module_id` 推断，或统一设为默认知识库）

### 阶段2：后端API扩展

#### 2.1 知识库管理API
**文件**: `backend/routes/knowledge-bases.js` (新建)

**端点**:
- `GET /api/knowledge-bases` - 获取所有知识库列表
- `GET /api/knowledge-bases/:id` - 获取知识库详情
- `POST /api/knowledge-bases` - 创建新知识库
- `PUT /api/knowledge-bases/:id` - 更新知识库
- `DELETE /api/knowledge-bases/:id` - 删除知识库（需检查是否有文档/模块）
- `GET /api/knowledge-bases/:id/stats` - 获取知识库统计信息

#### 2.2 模块API调整
**文件**: `backend/routes/modules.js`

**修改**:
- 所有查询添加 `knowledge_base_id` 过滤条件
- `GET /api/modules/grouped/by-steps` 增加 `?knowledge_base_id=xxx` 参数
- `GET /api/modules/:id/documents` 自动过滤当前知识库的文档
- `GET /api/modules/:id/stats` 统计当前知识库的数据

#### 2.3 文档API调整
**文件**: `backend/routes/upload.js`, `backend/routes/items.js`

**修改**:
- 上传文档时支持指定 `knowledge_base_id`
- 文档列表查询支持按 `knowledge_base_id` 过滤
- 文档更新支持修改 `knowledge_base_id`

### 阶段3：前端状态管理

#### 3.1 知识库状态管理
**文件**: `frontend/js/knowledge-bases.js` (新建)

**功能**:
- 管理当前选中的知识库ID
- 存储知识库列表
- 提供切换知识库的方法
- 持久化当前知识库选择（localStorage）

#### 3.2 模块系统调整
**文件**: `frontend/js/modules.js`

**修改**:
- `initModules()` 接收 `knowledge_base_id` 参数
- 所有API调用包含 `knowledge_base_id`
- 模块状态按知识库隔离

#### 3.3 咨询工作区调整
**文件**: `frontend/js/consultation.js`

**修改**:
- 文档列表按当前知识库过滤
- 对话历史按知识库隔离存储（localStorage key包含知识库ID）
- 上传文档时选择目标知识库

### 阶段4：前端UI实现

#### 4.1 知识库切换器
**文件**: `frontend/index.html`, `frontend/js/knowledge-bases.js`

**位置**: 咨询工作台顶部，模块导航上方

**UI设计**:
```
┌─────────────────────────────────────┐
│ 📚 知识库: [创业流程 ▼]              │
│   └─ 产品设计                        │
│   └─ 技术学习                        │
│   └─ + 新建知识库                    │
└─────────────────────────────────────┘
```

**功能**:
- 下拉选择器显示所有知识库
- 高亮当前知识库
- 显示知识库图标和名称
- 支持快速切换
- 新建知识库入口

#### 4.2 知识库管理界面
**文件**: `frontend/js/knowledge-bases.js`

**功能**:
- 创建知识库（名称、描述、图标、颜色）
- 编辑知识库信息
- 删除知识库（需确认，检查是否有数据）
- 设置默认知识库

#### 4.3 模块导航调整
**文件**: `frontend/js/modules.js`, `frontend/index.html`

**修改**:
- 模块导航标题显示当前知识库名称
- 切换知识库时自动刷新模块列表
- 保持展开/折叠状态（按知识库分别存储）

#### 4.4 文档上传调整
**文件**: `frontend/index.html` (上传模态框)

**修改**:
- 上传文档时显示知识库选择器
- 默认选择当前知识库
- 支持切换目标知识库

#### 4.5 模块选择器调整
**文件**: `frontend/js/consultation.js` (showModuleSelectorForDoc)

**修改**:
- 只显示当前知识库的模块
- 模块选择器标题显示知识库名称

### 阶段5：数据迁移和兼容性

#### 5.1 数据迁移脚本
**文件**: `backend/scripts/migrate-to-multi-knowledge-bases.js`

**步骤**:
1. 创建默认知识库"创业流程"
2. 迁移现有模块到默认知识库
3. 迁移现有文档到默认知识库（基于module_id推断）
4. 验证数据完整性

#### 5.2 向后兼容
- 如果 `knowledge_base_id` 为空，默认使用默认知识库
- API调用不传 `knowledge_base_id` 时，使用默认知识库
- 前端localStorage迁移：检测旧格式，自动转换

### 阶段6：用户体验优化

#### 6.1 知识库切换动画
- 切换知识库时显示加载状态
- 平滑过渡效果

#### 6.2 知识库统计信息
- 显示每个知识库的文档数、对话数
- 在知识库切换器中显示统计

#### 6.3 知识库图标和颜色
- 支持为每个知识库设置图标和主题色
- 在UI中使用知识库颜色主题

## 技术细节

### 数据库迁移策略
1. 使用事务确保数据一致性
2. 先创建新表结构
3. 迁移数据
4. 验证后删除旧表（可选）

### API设计
- RESTful风格
- 统一错误处理
- 支持分页（如需要）

### 前端状态管理
- 使用localStorage持久化当前知识库选择
- 对话历史按知识库隔离：`consultation_conversations_kb_${kbId}_module_${moduleId}`

### 性能优化
- 知识库列表缓存
- 模块数据按需加载
- 避免重复API调用

## 文件清单

### 新建文件
- `backend/routes/knowledge-bases.js` - 知识库管理API
- `backend/scripts/add-knowledge-bases.js` - 创建知识库表
- `backend/scripts/migrate-modules-to-knowledge-bases.js` - 迁移模块表
- `backend/scripts/add-knowledge-base-to-documents.js` - 扩展文档表
- `backend/scripts/migrate-to-multi-knowledge-bases.js` - 完整迁移脚本
- `frontend/js/knowledge-bases.js` - 知识库前端管理

### 修改文件
- `backend/routes/modules.js` - 添加知识库过滤
- `backend/routes/upload.js` - 支持知识库选择
- `backend/routes/items.js` - 支持知识库过滤
- `backend/app.js` - 注册知识库路由
- `frontend/js/modules.js` - 支持知识库切换
- `frontend/js/consultation.js` - 按知识库过滤文档和对话
- `frontend/index.html` - 添加知识库切换器UI

## 测试要点

1. 创建新知识库
2. 切换知识库
3. 在不同知识库上传文档
4. 模块导航正确显示当前知识库的模块
5. 文档列表正确过滤
6. 对话历史按知识库隔离
7. 数据迁移后现有数据正常显示

## 注意事项

1. **数据完整性**: 确保所有现有数据正确迁移到默认知识库
2. **向后兼容**: 支持旧版本API调用（不传knowledge_base_id）
3. **用户体验**: 知识库切换要快速、流畅
4. **数据隔离**: 确保不同知识库的数据不会混淆
5. **默认行为**: 新用户默认使用默认知识库

