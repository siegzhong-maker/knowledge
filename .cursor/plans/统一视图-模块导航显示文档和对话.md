# 统一视图：在模块导航中直接显示文档和对话

## 设计目标

将文档和对话直接集成到模块导航中，展开模块时显示该模块的文档和对话列表，让用户一目了然地看到每个模块包含的内容。

## 当前问题分析

1. **文档和对话分离**：文档在"参考文档"区域，对话在"对话历史"区域，用户不清楚它们与模块的关系
2. **切换模块时混淆**：切换模块后文档会变化，但对话历史仍然显示所有模块的对话，容易混淆
3. **视觉关联不明确**：用户需要理解"当前模块"的概念，才能知道哪些内容属于哪个模块

## 设计方案

### UI结构

```
左侧栏
├─ 6步18关导航
│  ├─ 未分类（可展开）
│  │  └─ [展开后显示]
│  │     ├─ 📄 文档列表（3个）
│  │     └─ 💬 对话列表（2个）
│  ├─ 第1步：选方向（可展开）
│  │  └─ [展开后显示]
│  │     ├─ 1.1 找风口
│  │     │  └─ [点击后显示该关卡的文档和对话]
│  │     ├─ 1.2 寻初心
│  │     └─ ...
│  └─ ...
└─ [可选] 全局视图（折叠状态）
   ├─ 所有文档
   └─ 所有对话
```

### 交互逻辑

1. **展开步骤**：点击步骤标题，展开显示该步骤下的所有关卡
2. **展开关卡**：点击关卡，显示该关卡的文档列表和对话列表（直接内嵌在关卡下）
3. **切换模块**：点击关卡时，自动切换到该模块，并展开显示文档和对话
4. **视觉反馈**：
   - 当前激活的模块高亮显示
   - 展开的模块显示文档和对话列表
   - 文档和对话数量实时显示

## 实施步骤

### 1. 修改模块导航渲染逻辑

**文件**: `frontend/js/modules.js`

- 修改 `renderModuleNavigation()` 函数
- 在关卡按钮下方添加展开区域，用于显示文档和对话
- 添加文档和对话的内联显示容器

**关键改动**:
- 在关卡按钮后添加展开内容区域
- 使用独立的容器ID：`checkpoint-${checkpoint.id}-content`
- 默认隐藏，点击关卡时展开

### 2. 实现关卡展开/折叠功能

**文件**: `frontend/js/modules.js`

- 添加 `toggleCheckpoint(checkpointId)` 函数
- 展开时加载并显示该关卡的文档和对话
- 折叠时隐藏内容
- 保存展开状态到 localStorage

**功能**:
- 展开关卡时调用 `loadCheckpointContent(checkpointId)`
- 加载文档列表和对话列表
- 更新展开状态到 localStorage：`checkpoint-${checkpointId}-expanded`

### 3. 实现文档和对话的内联加载

**文件**: `frontend/js/modules.js`

- 添加 `loadCheckpointContent(checkpointId)` 函数
- 从API加载文档列表：`/api/modules/${checkpointId}/documents`
- 从localStorage加载对话列表：`consultation_conversations_module_${checkpointId}`
- 渲染到关卡展开区域

### 4. 优化文档和对话的渲染组件

**文件**: `frontend/js/modules.js`

- 创建 `renderCheckpointDocuments(documents, containerId)` 函数
- 创建 `renderCheckpointConversations(conversations, containerId)` 函数
- 使用紧凑的卡片样式，适合内嵌显示

**样式要求**:
- 文档卡片：显示标题、类型图标、时间，点击加载到右侧面板
- 对话卡片：显示预览文本、时间、消息数，点击加载对话历史
- 紧凑布局，适合在模块导航中显示

### 5. 调整"参考文档"和"对话历史"区域

**文件**: `frontend/index.html`, `frontend/js/consultation.js`

**选项A（推荐）**：保留作为"全局视图"
- 重命名为"所有文档"和"所有对话"
- 默认折叠，点击展开查看所有内容
- 作为快速访问的补充

**选项B**：移除这两个区域
- 完全依赖模块导航中的内联显示
- 简化界面

### 6. 更新模块切换逻辑

**文件**: `frontend/js/modules.js`

- 修改 `switchToModule()` 函数
- 切换模块时，自动展开该模块并显示内容
- 更新右侧面板的文档显示（如果需要）

### 7. 优化未分类模块的显示

**文件**: `frontend/js/modules.js`

- 未分类模块展开时，显示未分类的文档和对话
- 使用相同的内联显示方式

## 技术实现细节

### 数据结构

```javascript
// 关卡内容缓存
const checkpointContentCache = {
  [checkpointId]: {
    documents: [],
    conversations: [],
    loadedAt: timestamp
  }
};
```

### API调用

- 文档列表：`GET /api/modules/:id/documents`
- 对话列表：从localStorage读取，格式：`consultation_conversations_module_${moduleId}`

### 事件处理

- `checkpointExpanded`: 关卡展开事件
- `checkpointCollapsed`: 关卡折叠事件
- `documentClicked`: 文档点击事件（加载到右侧面板）
- `conversationClicked`: 对话点击事件（加载对话历史）

## 视觉设计

### 展开状态示例

```
┌─────────────────────────────┐
│ 第1步：选方向            [▲] │
├─────────────────────────────┤
│ ○ 1.1 找风口            [▼] │
│   📄 2文档 💬 3对话          │
│   ┌─────────────────────┐   │
│   │ 📄 市场分析报告.pdf │   │ ← 展开后显示
│   │ 📄 行业趋势.pdf     │   │
│   ├─────────────────────┤   │
│   │ 💬 如何找风口？     │   │
│   │ 💬 市场分析讨论     │   │
│   └─────────────────────┘   │
└─────────────────────────────┘
```

### 样式规范

- 文档列表：紧凑卡片，hover高亮，点击加载到右侧
- 对话列表：紧凑卡片，显示预览和时间，点击加载对话
- 展开动画：平滑展开（200ms transition）
- 当前激活：蓝色边框和背景高亮

## 文件修改清单

### 主要修改

1. `frontend/js/modules.js`
   - 修改 `renderModuleNavigation()` - 添加内联文档和对话显示容器
   - 添加 `toggleCheckpoint()` - 关卡展开/折叠
   - 添加 `loadCheckpointContent()` - 加载关卡内容
   - 添加 `renderCheckpointDocuments()` - 渲染文档列表
   - 添加 `renderCheckpointConversations()` - 渲染对话列表
   - 修改 `switchToModule()` - 自动展开并显示内容

2. `frontend/js/consultation.js`
   - 修改文档点击处理，支持从模块导航点击
   - 修改对话点击处理，支持从模块导航点击
   - 可选：调整"参考文档"和"对话历史"区域

3. `frontend/index.html`
   - 可选：调整"参考文档"和"对话历史"区域的说明文字
   - 可选：添加"全局视图"折叠功能

## 实施优先级

### Phase 1: 核心功能
1. 实现关卡展开/折叠功能
2. 实现文档和对话的内联加载
3. 实现文档和对话的内联渲染

### Phase 2: 优化体验
1. 添加展开动画
2. 优化卡片样式
3. 添加加载状态提示

### Phase 3: 可选增强
1. 调整或移除"参考文档"/"对话历史"区域
2. 添加搜索功能（在模块内搜索）
3. 添加批量操作（批量移动文档等）

## 注意事项

1. **性能优化**：
   - 使用缓存避免重复加载
   - 延迟加载（只在展开时加载）
   - 限制显示的文档/对话数量（如最多显示10个，提供"查看更多"）

2. **兼容性**：
   - 保持现有的模块切换功能
   - 保持现有的文档查看功能
   - 保持现有的对话加载功能

3. **用户体验**：
   - 清晰的视觉层次
   - 流畅的展开/折叠动画
   - 明确的交互反馈

