# 数据库迁移指南

## 概述

将现有数据库迁移到多知识库系统，将现有的"6步18关"数据迁移到默认知识库"创业流程"。

## 迁移步骤

### 1. 备份数据库（重要！）

在迁移之前，请先备份数据库：

```bash
# 复制数据库文件
cp database/knowledge.db database/knowledge.db.backup
```

### 2. 执行迁移脚本

运行迁移脚本：

```bash
node backend/scripts/migrate-to-multi-knowledge-bases.js
```

或者如果使用npm：

```bash
npm run migrate-kb
```

（如果package.json中没有这个脚本，可以直接运行上面的node命令）

### 3. 迁移过程

迁移脚本会执行以下操作：

1. **创建知识库表** (`knowledge_bases`)
   - 创建表结构
   - 插入默认知识库"创业流程"（ID: `kb-entrepreneurship`）

2. **创建模块表** (`modules`)
   - 创建新的modules表（包含`knowledge_base_id`字段）
   - 从旧的`entrepreneurship_modules`表迁移数据
   - 所有模块归属到默认知识库

3. **扩展文档表** (`source_items`)
   - 添加`knowledge_base_id`字段
   - 根据文档的`module_id`推断知识库
   - 没有模块的文档统一归属到默认知识库

### 4. 验证迁移结果

迁移完成后，可以验证：

```bash
# 使用sqlite3命令行工具
sqlite3 database/knowledge.db

# 检查知识库
SELECT * FROM knowledge_bases;

# 检查模块（应该都有knowledge_base_id）
SELECT id, knowledge_base_id, step_name, checkpoint_name FROM modules LIMIT 5;

# 检查文档（应该都有knowledge_base_id）
SELECT id, title, knowledge_base_id FROM source_items WHERE type='pdf' LIMIT 5;
```

## 迁移后的数据结构

### 知识库表
```
id: kb-entrepreneurship
name: 创业流程
description: 6步18关创业知识体系
is_default: 1
```

### 模块表
- 所有现有模块的`knowledge_base_id`都设置为`kb-entrepreneurship`
- 模块ID格式：`kb-entrepreneurship-step{stepNumber}-checkpoint{checkpointNumber}`

### 文档表
- 所有现有文档的`knowledge_base_id`都设置为`kb-entrepreneurship`
- 根据文档的`module_id`自动推断知识库

## 注意事项

1. **数据安全**
   - 迁移前务必备份数据库
   - 迁移是不可逆的（虽然旧表数据保留）

2. **向后兼容**
   - 旧的`entrepreneurship_modules`表仍然存在（作为备份）
   - API会自动兼容，优先使用新的`modules`表

3. **迁移后操作**
   - 重启后端服务
   - 刷新前端页面
   - 系统会自动加载默认知识库

4. **如果迁移失败**
   - 恢复备份：`cp database/knowledge.db.backup database/knowledge.db`
   - 检查错误日志
   - 确保数据库文件可写

## 迁移脚本输出示例

```
已连接到SQLite数据库
开始多知识库系统迁移...

✓ 步骤1: knowledge_bases表已创建
✓ 步骤2: 已创建默认知识库：创业流程
✓ 步骤3: modules表已创建
✓ 步骤4: 已迁移 18 个模块到modules表
✓ 步骤5: source_items表已添加knowledge_base_id列
✓ 步骤6: 已更新 15 个文档的knowledge_base_id

✓ 多知识库系统迁移完成！

迁移摘要:
  - 默认知识库ID: kb-entrepreneurship
  - 所有现有模块和文档已迁移到默认知识库

下一步:
  1. 重启后端服务
  2. 刷新前端页面
  3. 可以开始创建新的知识库了！
```

## 常见问题

### Q: 迁移后旧数据还在吗？
A: 是的，旧的`entrepreneurship_modules`表仍然保留作为备份，但系统会优先使用新的`modules`表。

### Q: 可以回滚迁移吗？
A: 可以，使用备份文件恢复即可。但建议在迁移前做好备份。

### Q: 迁移需要多长时间？
A: 通常几秒钟即可完成，取决于数据量。

### Q: 迁移后需要重启服务吗？
A: 是的，需要重启后端服务以加载新的API路由。

## 手动迁移（高级）

如果需要手动执行迁移步骤：

```bash
# 步骤1: 创建知识库表
node backend/scripts/add-knowledge-bases.js

# 步骤2: 迁移模块表
node backend/scripts/migrate-modules-to-knowledge-bases.js

# 步骤3: 扩展文档表
node backend/scripts/add-knowledge-base-to-documents.js
```

或者使用完整迁移脚本（推荐）：

```bash
node backend/scripts/migrate-to-multi-knowledge-bases.js
```

